<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dass - Gestão de Veículos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #4f46e5; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        .fc-event { border: none !important; border-radius: 12px !important; cursor: pointer; transition: transform 0.2s; }
        .fc-event:hover { transform: scale(1.02); }
        .calendar-img { width: 100%; height: 60px; object-fit: cover; border-radius: 8px 8px 0 0; }
        .bg-gradient-dass { background: linear-gradient(135deg, #4f46e5 0%, #312e81 100%); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">

    <!-- OVERLAY DE CARREGAMENTO -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-100 h-16 w-16 mb-4"></div>
        <p class="text-indigo-600 font-black text-xs uppercase tracking-[0.3em] animate-pulse">Sincronizando Frota...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 pb-8 border-b border-slate-200 gap-6">
            <div class="flex items-center gap-5">
                <div class="bg-gradient-dass p-4 rounded-[24px] shadow-xl shadow-indigo-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </div>
                <div>
                    <h1 class="text-4xl font-[900] tracking-tighter text-slate-800">DASS <span class="text-indigo-600">FROTA</span></h1>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Gestão Inteligente de Logística</p>
                </div>
            </div>
            
            <div id="user-pill" class="hidden bg-white px-6 py-3 rounded-full shadow-sm border border-slate-100 flex items-center gap-4">
                <div class="text-right">
                    <p id="user-email" class="text-sm font-black text-slate-700 leading-none">...</p>
                    <span id="user-badge" class="text-[9px] font-black uppercase tracking-widest text-indigo-500">Utilizador</span>
                </div>
                <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 font-bold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2"/></svg>
                </div>
            </div>
        </header>

        <!-- DASHBOARD INICIAL (UX 3-CLICKS) -->
        <section id="page-hub" class="page-section animate-in fade-in zoom-in duration-500">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Atalho Reserva -->
                <div onclick="navigateTo('reservas')" class="bg-gradient-dass p-10 rounded-[50px] shadow-2xl shadow-indigo-200 cursor-pointer hover:scale-[1.02] transition-transform group">
                    <div class="bg-white/10 w-16 h-16 rounded-3xl flex items-center justify-center text-white mb-8 group-hover:bg-white/20">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                    </div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tighter">Nova Reserva</h2>
                    <p class="text-indigo-100 text-sm mt-2 opacity-80">Agende um veículo em menos de 1 minuto.</p>
                </div>

                <!-- Atalho Calendário -->
                <div onclick="navigateTo('calendario')" class="bg-white p-10 rounded-[50px] shadow-sm border border-slate-100 cursor-pointer hover:shadow-xl transition-all group">
                    <div class="bg-indigo-50 w-16 h-16 rounded-3xl flex items-center justify-center text-indigo-600 mb-8 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    </div>
                    <h2 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Ver Agenda</h2>
                    <p class="text-slate-400 text-sm mt-2 font-medium">Consulte a disponibilidade da frota.</p>
                </div>

                <!-- Atalho Frota -->
                <div onclick="navigateTo('frota')" class="bg-white p-10 rounded-[50px] shadow-sm border border-slate-100 cursor-pointer hover:shadow-xl transition-all group">
                    <div class="bg-slate-50 w-16 h-16 rounded-3xl flex items-center justify-center text-slate-600 mb-8 group-hover:bg-slate-800 group-hover:text-white transition-colors">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5"/></svg>
                    </div>
                    <h2 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Frota</h2>
                    <p class="text-slate-400 text-sm mt-2 font-medium">Catálogo completo de veículos.</p>
                </div>
            </div>

            <!-- Botão ADM Condutores -->
            <div id="adm-driver-btn" class="hidden mt-12 flex justify-center">
                <button onclick="navigateTo('cadastro-motorista')" class="flex items-center gap-3 px-10 py-5 bg-emerald-600 text-white font-black rounded-full shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    GESTÃO DE CONDUTORES (ADM)
                </button>
            </div>
        </section>

        <!-- VOLTAR -->
        <div id="back-btn" class="hidden mb-10">
            <button onclick="navigateTo('hub')" class="bg-white px-8 py-3 rounded-2xl border-2 border-slate-100 font-black text-xs text-slate-500 uppercase tracking-widest hover:bg-slate-100 transition flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg> Voltar
            </button>
        </div>

        <!-- PÁGINA: RESERVAS -->
        <section id="page-reservas" class="page-section hidden">
            <div class="bg-white p-10 md:p-16 rounded-[60px] shadow-sm border border-slate-100">
                <h2 class="text-4xl font-black text-slate-800 uppercase tracking-tighter mb-10">Agendar Veículo</h2>
                
                <form id="booking-form" class="space-y-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Veículo Disponível</label>
                            <select id="veiculo-select" name="veiculo" class="w-full p-5 bg-slate-50 border-2 border-transparent focus:border-indigo-600 rounded-[24px] outline-none font-bold transition" onchange="handleVehicleChange()" required></select>
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Condutor Habilitado</label>
                            <select id="motorista-select" name="motorista" class="w-full p-5 bg-slate-50 border-2 border-transparent focus:border-indigo-600 rounded-[24px] outline-none font-bold transition" required></select>
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Início da Utilização</label>
                            <input type="datetime-local" name="inicio" class="w-full p-5 bg-slate-50 border-2 border-transparent focus:border-indigo-600 rounded-[24px] outline-none font-bold transition" required>
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Fim (Retorno Previsto)</label>
                            <input type="datetime-local" name="fim" class="w-full p-5 bg-slate-50 border-2 border-transparent focus:border-indigo-600 rounded-[24px] outline-none font-bold transition" required>
                        </div>
                    </div>

                    <!-- SEÇÃO DE PASSAGEIROS (INDICADORES VISUAIS) -->
                    <div id="passengers-section" class="hidden animate-in fade-in duration-500">
                        <div class="bg-indigo-50/50 p-8 rounded-[40px] border-2 border-indigo-100">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                                <div>
                                    <h3 class="text-xl font-black text-indigo-900 uppercase tracking-tighter">Passageiros</h3>
                                    <p class="text-rose-500 text-[11px] font-black uppercase tracking-widest mt-1">⚠️ NÃO REGISTRE O MOTORISTA NESTE CAMPO</p>
                                </div>
                                <div class="bg-white px-6 py-2 rounded-2xl shadow-sm border border-indigo-100 text-center">
                                    <p id="seats-text" class="text-xs font-black text-indigo-600 uppercase">Aguardando...</p>
                                    <div class="w-40 h-2 bg-slate-100 rounded-full mt-1 overflow-hidden">
                                        <div id="seats-progress" class="h-full bg-indigo-600 transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="passenger-inputs" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Origem</label>
                            <input type="text" name="origem" placeholder="Ex: Filial VDC" class="w-full p-5 bg-slate-50 border-2 border-transparent focus:border-indigo-600 rounded-[24px] outline-none font-bold transition" required>
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Destino</label>
                            <input type="text" name="destino" placeholder="Ex: Galpão Central" class="w-full p-5 bg-slate-50 border-2 border-transparent focus:border-indigo-600 rounded-[24px] outline-none font-bold transition" required>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] ml-2">Finalidade do Trajeto</label>
                        <textarea name="motivo" rows="3" class="w-full p-5 bg-slate-50 border-2 border-transparent focus:border-indigo-600 rounded-[24px] outline-none font-bold transition" placeholder="Descreva brevemente o motivo da viagem..." required></textarea>
                    </div>

                    <button type="submit" id="btn-submit-booking" class="w-full py-6 bg-indigo-600 text-white font-black rounded-[30px] text-xl shadow-2xl shadow-indigo-100 hover:bg-indigo-700 active:scale-[0.98] transition-all">CONCLUIR RESERVA</button>
                </form>
            </div>
        </section>

        <!-- PÁGINA: CALENDÁRIO -->
        <section id="page-calendario" class="page-section hidden">
            <h2 class="text-4xl font-black text-slate-800 uppercase tracking-tighter mb-8">Agenda da Frota</h2>
            <div class="bg-white p-8 rounded-[50px] shadow-sm border border-slate-100 min-h-[600px]">
                <div id="calendar"></div>
            </div>
        </section>

        <!-- PÁGINA: FROTA -->
        <section id="page-frota" class="page-section hidden">
            <div class="flex justify-between items-center mb-12">
                <h2 class="text-4xl font-black text-slate-800 uppercase tracking-tighter">Catálogo de Veículos</h2>
                <button id="adm-add-vehicle" onclick="editVehicle(null)" class="hidden bg-indigo-600 text-white px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl">Adicionar Veículo</button>
            </div>
            <div id="frota-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>
        </section>

        <!-- PÁGINA: CONDUTORES (ADM) -->
        <section id="page-cadastro-motorista" class="page-section hidden">
            <h2 class="text-4xl font-black text-slate-800 uppercase tracking-tighter mb-8">Gestão de Condutores</h2>
            <div id="drivers-container" class="bg-white rounded-[40px] shadow-sm overflow-hidden border border-slate-100">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                            <th class="p-6">Nome / Crachá</th>
                            <th class="p-6">Categoria</th>
                            <th class="p-6">Validade CNH</th>
                            <th class="p-6">Status</th>
                            <th class="p-6">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="drivers-list" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </section>

        <!-- MODAL DE DETALHES DA RESERVA -->
        <div id="booking-modal" class="hidden fixed inset-0 z-[150] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-[60px] p-10 shadow-2xl animate-in zoom-in duration-300">
                <div class="flex justify-between items-start mb-10">
                    <div class="flex items-center gap-6">
                        <div id="modal-vehicle-img" class="w-32 h-32 rounded-[30px] overflow-hidden bg-slate-100 shadow-lg"></div>
                        <div>
                            <h2 id="modal-vehicle-name" class="text-3xl font-black text-slate-800 tracking-tighter uppercase leading-none">...</h2>
                            <p id="modal-vehicle-placa" class="text-indigo-600 font-black text-lg tracking-widest mt-1">...</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="p-3 bg-slate-50 text-slate-400 rounded-2xl hover:bg-slate-100 transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5"/></svg></button>
                </div>

                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="bg-slate-50 p-6 rounded-[32px]">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Condutor Designado</p>
                        <p id="modal-driver" class="font-black text-slate-800">...</p>
                    </div>
                    <div id="modal-occupancy" class="bg-indigo-50 p-6 rounded-[32px] border border-indigo-100">
                        <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Ocupação</p>
                        <p id="modal-occupancy-text" class="font-black text-indigo-800">...</p>
                    </div>
                </div>

                <div class="bg-slate-50 p-6 rounded-[32px] mb-10">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 text-center">Trajeto Previsto</p>
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1 text-center"><p class="text-[10px] font-bold text-slate-400">Origem</p><p id="modal-origin" class="font-black text-slate-700">...</p></div>
                        <div class="w-8 h-px bg-slate-300"></div>
                        <div class="flex-1 text-center"><p class="text-[10px] font-bold text-slate-400">Destino</p><p id="modal-dest" class="font-black text-slate-700">...</p></div>
                    </div>
                </div>

                <div id="modal-footer" class="flex gap-4">
                    <button id="btn-delete-res" class="hidden flex-1 py-5 bg-rose-50 text-rose-600 font-black rounded-[24px] hover:bg-rose-600 hover:text-white transition uppercase text-xs tracking-widest">Cancelar Reserva</button>
                    <button onclick="closeModal()" class="flex-1 py-5 bg-slate-800 text-white font-black rounded-[24px] uppercase text-xs tracking-widest">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let currentUser = null;
        let vehiclesCache = [];
        let calendarRef = null;
        const ADM_EMAIL = "tem.vdcconf@grupodass.com.br";

        // --- INICIALIZAÇÃO ---
        function initializeApp() {
            google.script.run
                .withSuccessHandler(user => {
                    currentUser = user;
                    updateUIForUser();
                    loadData();
                })
                .withFailureHandler(err => alert("Erro ao conectar: " + err.message))
                .getUserInfo();
        }

        function updateUIForUser() {
            const pill = document.getElementById('user-pill');
            const emailEl = document.getElementById('user-email');
            const badgeEl = document.getElementById('user-badge');
            
            emailEl.innerText = currentUser.email;
            pill.classList.remove('hidden');

            if (currentUser.nivel === 'ADM') {
                badgeEl.innerText = "ADMINISTRADOR CENTRAL";
                badgeEl.classList.replace('text-indigo-500', 'text-emerald-600');
                document.getElementById('adm-driver-btn').classList.remove('hidden');
                document.getElementById('adm-add-vehicle').classList.remove('hidden');
            }
        }

        function loadData() {
            // Veículos
            google.script.run.withSuccessHandler(v => {
                vehiclesCache = v;
                populateSelect('veiculo-select', v.filter(x => x.status === 'Ativo').map(x => ({ val: x.placa, text: `${x.modelo} [${x.placa}]` })));
                renderFrota(v);
                checkLoadComplete();
            }).getVehicles();

            // Motoristas
            google.script.run.withSuccessHandler(m => {
                populateSelect('motorista-select', m.map(x => ({ val: x.nome, text: x.nome })));
            }).getDrivers();

            // Reservas para o Calendário
            google.script.run.withSuccessHandler(bookings => {
                initCalendar(bookings);
            }).getBookings();

            // Condutores se for ADM
            if (currentUser.nivel === 'ADM') {
                google.script.run.withSuccessHandler(renderDrivers).getFullMotoristasList();
            }
        }

        function checkLoadComplete() {
            setTimeout(() => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen').classList.add('hidden'), 500);
            }, 800);
        }

        // --- LÓGICA DE PASSAGEIROS ---
        function handleVehicleChange() {
            const placa = document.getElementById('veiculo-select').value;
            const container = document.getElementById('passenger-inputs');
            const section = document.getElementById('passengers-section');
            const vehicle = vehiclesCache.find(v => v.placa === placa);

            if (!vehicle || vehicle.assentos <= 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            let html = '';
            for (let i = 1; i <= vehicle.assentos; i++) {
                html += `
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-indigo-300 uppercase tracking-widest ml-2">Ocupante ${i}</label>
                        <input type="text" class="passenger-name w-full p-4 rounded-2xl border-2 border-white focus:border-indigo-400 outline-none font-bold text-xs shadow-sm transition" placeholder="Nome Completo..." oninput="updateOccupancy(${vehicle.assentos})">
                    </div>`;
            }
            container.innerHTML = html;
            updateOccupancy(vehicle.assentos);
        }

        function updateOccupancy(total) {
            const inputs = document.querySelectorAll('.passenger-name');
            const filled = Array.from(inputs).filter(i => i.value.trim() !== '').length;
            const progress = (filled / total) * 100;
            const remaining = total - filled;

            document.getElementById('seats-progress').style.width = progress + '%';
            document.getElementById('seats-text').innerText = `${filled} OCUPADOS | ${remaining} VAGAS LIVRES`;
        }

        // --- CALENDÁRIO ---
        function initCalendar(bookings) {
            const el = document.getElementById('calendar');
            const events = bookings.map(b => {
                const v = vehiclesCache.find(x => x.placa === b.veiculo);
                return {
                    id: b.id,
                    title: `${b.veiculo} - ${b.motorista}`,
                    start: b.inicio,
                    end: b.fim,
                    backgroundColor: '#4f46e5',
                    extendedProps: { ...b, vImg: v ? v.img : '' }
                };
            });

            if (calendarRef) calendarRef.destroy();
            calendarRef = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                events: events,
                eventContent: function(arg) {
                    const img = arg.event.extendedProps.vImg;
                    return {
                        html: `
                            <div class="flex flex-col h-full bg-indigo-600 rounded-lg overflow-hidden border border-white/20">
                                ${img ? `<img src="${img}" class="calendar-img">` : '<div class="h-[60px] bg-indigo-900 flex items-center justify-center text-[10px] text-indigo-400 font-bold">FROTA</div>'}
                                <div class="p-1.5"><p class="text-[9px] font-black text-white uppercase truncate">${arg.event.title}</p></div>
                            </div>`
                    };
                },
                eventClick: (info) => openBookingDetails(info.event.extendedProps)
            });
            if (!document.getElementById('page-calendario').classList.contains('hidden')) calendarRef.render();
        }

        function openBookingDetails(b) {
            const v = vehiclesCache.find(x => x.placa === b.veiculo);
            const passList = b.passageiros ? b.passageiros.split(',') : [];
            const capacity = v ? v.assentos : 0;

            document.getElementById('modal-vehicle-img').innerHTML = v && v.img ? `<img src="${v.img}" class="w-full h-full object-cover">` : '';
            document.getElementById('modal-vehicle-name').innerText = v ? v.modelo : "Veículo";
            document.getElementById('modal-vehicle-placa').innerText = b.veiculo;
            document.getElementById('modal-driver').innerText = b.motorista;
            document.getElementById('modal-occupancy-text').innerText = `${passList.length} Passageiros | ${capacity - passList.length} Vagas`;
            document.getElementById('modal-origin').innerText = b.origem || "Não informado";
            document.getElementById('modal-dest').innerText = b.destino || "Não informado";

            // Permissões de exclusão
            const btnDel = document.getElementById('btn-delete-res');
            if (currentUser.nivel === 'ADM' || b.usuario.toLowerCase() === currentUser.email.toLowerCase()) {
                btnDel.classList.remove('hidden');
                btnDel.onclick = () => handleDeleteBooking(b.id);
            } else {
                btnDel.classList.add('hidden');
            }

            document.getElementById('booking-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('booking-modal').classList.add('hidden'); }

        // --- RENDERIZADORES ---
        function renderFrota(list) {
            const grid = document.getElementById('frota-grid');
            grid.innerHTML = list.map(v => {
                const isAdmin = currentUser.nivel === 'ADM';
                return `
                <div class="bg-white rounded-[45px] shadow-sm border border-slate-50 overflow-hidden group hover:shadow-2xl transition-all">
                    <div class="h-56 bg-slate-100 relative">
                        ${v.img ? `<img src="${v.img}" class="w-full h-full object-cover">` : ''}
                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur px-4 py-1.5 rounded-2xl">
                             <span class="text-[10px] font-black uppercase text-indigo-600 tracking-widest">${v.status}</span>
                        </div>
                    </div>
                    <div class="p-8 text-center">
                        <h3 class="font-black text-2xl text-slate-800 uppercase tracking-tighter leading-none">${v.modelo}</h3>
                        <p class="text-indigo-600 font-black tracking-widest text-sm mt-1 uppercase">${v.placa}</p>
                        <div class="mt-6 inline-block bg-indigo-50 px-6 py-2 rounded-2xl border border-indigo-100 text-indigo-600 text-xs font-black uppercase tracking-widest">
                            ${v.assentos} Passageiros + 1 Motorista
                        </div>
                        ${isAdmin ? `
                            <div class="mt-8 flex gap-2">
                                <button onclick="editVehicle('${v.placa}')" class="flex-1 bg-slate-800 text-white py-3 rounded-2xl font-black text-[10px] uppercase hover:bg-indigo-600 transition">Editar</button>
                                <button onclick="handleDeleteVehicle('${v.placa}')" class="bg-rose-50 text-rose-500 px-4 rounded-2xl hover:bg-rose-600 hover:text-white transition">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function renderDrivers(list) {
            const listEl = document.getElementById('drivers-list');
            listEl.innerHTML = list.map(d => {
                const daysLeft = Math.floor((new Date(d.validade) - new Date()) / (1000 * 60 * 60 * 24));
                const highlight = daysLeft < 30 ? 'text-rose-600' : 'text-slate-600';
                return `
                <tr class="hover:bg-slate-50/50 transition font-medium">
                    <td class="p-6 font-black uppercase text-slate-800">${d.nome}<br><span class="text-[10px] text-slate-400">ID: ${d.cracha}</span></td>
                    <td class="p-6"><span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-xs font-black">CAT: ${d.tipo}</span></td>
                    <td class="p-6 ${highlight} font-black">${new Date(d.validade).toLocaleDateString('pt-PT')} ${daysLeft < 30 ? '⚠️' : ''}</td>
                    <td class="p-6"><span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${d.status === 'Ativo' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-500'}">${d.status}</span></td>
                    <td class="p-6"><button class="text-indigo-600 font-black text-[10px] uppercase hover:underline">Editar</button></td>
                </tr>`;
            }).join('');
        }

        // --- NAVEGAÇÃO ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById('back-btn').classList.toggle('hidden', pageId === 'hub');
            if (pageId === 'calendario' && calendarRef) setTimeout(() => calendarRef.render(), 100);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- SUBMISSÕES E AÇÕES ADM ---
        function editVehicle(placa) {
            const v = vehiclesCache.find(x => x.placa === placa) || { placa: '', modelo: '', status: 'Ativo', obs: '', assentos: 4, img: '' };
            
            const nPlaca = prompt("Placa do Veículo:", v.placa) || v.placa;
            if (!nPlaca) return;
            const nModelo = prompt("Modelo do Veículo:", v.modelo) || v.modelo;
            const nAssentos = prompt("Lotação (Passageiros):", v.assentos) || v.assentos;
            const nStatus = prompt("Status (Ativo/Inativo):", v.status) || v.status;
            const nImg = prompt("Link da Imagem:", v.img) || v.img;

            const payload = {
                placa: nPlaca,
                modelo: nModelo,
                assentos: parseInt(nAssentos),
                status: nStatus,
                img: nImg,
                obs: v.obs
            };

            google.script.run.withSuccessHandler(res => {
                alert(res.message);
                loadData();
            }).saveVehicle(payload);
        }

        function handleDeleteVehicle(placa) {
            if (confirm(`Tem certeza que deseja remover o veículo ${placa} permanentemente?`)) {
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    loadData();
                }).deleteVehicle(placa);
            }
        }

        document.getElementById('booking-form').onsubmit = function(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-booking');
            btn.disabled = true;
            btn.innerText = "GRAVANDO AGENDAMENTO...";

            const passengers = Array.from(document.querySelectorAll('.passenger-name'))
                .map(i => i.value.trim())
                .filter(v => v !== "")
                .join(", ");

            const data = Object.fromEntries(new FormData(this));
            data.passageiros = passengers;

            google.script.run.withSuccessHandler(res => {
                alert(res.message);
                navigateTo('hub');
                this.reset();
                btn.disabled = false;
                btn.innerText = "CONCLUIR RESERVA";
                loadData();
            }).createNewBooking(data);
        };

        function handleDeleteBooking(id) {
            if (confirm("Deseja cancelar esta reserva?")) {
                google.script.run.withSuccessHandler(res => {
                    alert(res.message);
                    closeModal();
                    loadData();
                }).deleteBooking(id);
            }
        }

        // --- UTILITÁRIOS ---
        function populateSelect(id, items) {
            const s = document.getElementById(id);
            if (!s) return;
            s.innerHTML = '<option value="">Selecione uma opção...</option>' + items.map(i => `<option value="${i.val}">${i.text}</option>`).join('');
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
